<!DOCTYPE html>
<html lang="he" dir="rtl">
<head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
    <title>סיכום סידור עבודה - לפי ימים</title>

    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Rubik:wght@300;400;500;600;700&display=swap" rel="stylesheet">

    <style>
    :root{
        --primary-color: #007bff;
        --primary-dark: #0056b3;
        --success-color: #28a745;
        --runner-bg: #28a745;
        --waiter-hall-bg: #38516d;
        --waiter-terrace-bg: #022346;
        --hostess-hall-bg: #96009b;
        --hostess-terrace-bg: #ff7fc7;
        --tastings-bg: #17a2b8;
        --light-gray: #f7fafc;
        --text-color: #2d3748;
        --card-bg: rgba(255, 255, 255, 0.95);
        --border-radius: 1rem;
        --shadow-light: 0 4px 6px rgba(0, 0, 0, 0.05);
        --shadow-medium: 0 10px 25px rgba(0, 0, 0, 0.1);
        --shadow-heavy: 0 20px 40px rgba(0, 0, 0, 0.15);
    }

    * {
        box-sizing: border-box;
    }

    html, body {
        height: 100vh;
        margin: 0;
        padding: 0;
    }

    body {
        font-family: 'Rubik', sans-serif;
        direction: rtl;
        background: linear-gradient(135deg, #007bff 0%, #0056b3 50%, #17a2b8 100%);
        color: var(--text-color);
        min-height: 100vh;
        padding: 1rem;
        overflow-x: auto;
    }

    .container {
        width: 100%;
        max-width: 100vw;
        margin: 0 auto;
        background: var(--card-bg);
        backdrop-filter: blur(20px);
        padding: 2rem;
        border-radius: var(--border-radius);
        box-shadow: var(--shadow-heavy);
        border: 1px solid rgba(255, 255, 255, 0.2);
        animation: fadeInUp 0.8s ease-out;
    }

    @keyframes fadeInUp {
        from {
            opacity: 0;
            transform: translateY(30px);
        }
        to {
            opacity: 1;
            transform: translateY(0);
        }
    }

    h2 {
        text-align: center;
        margin-bottom: 2rem;
        font-size: clamp(1.8rem, 4vw, 3rem);
        font-weight: 700;
        background: linear-gradient(135deg, var(--primary-color), var(--primary-dark));
        -webkit-background-clip: text;
        -webkit-text-fill-color: transparent;
        background-clip: text;
        text-shadow: 0 2px 4px rgba(0, 0, 0, 0.1);
        animation: slideInDown 0.6s ease-out;
    }

    @keyframes slideInDown {
        from {
            opacity: 0;
            transform: translateY(-20px);
        }
        to {
            opacity: 1;
            transform: translateY(0);
        }
    }

    .legend {
        display: grid;
        grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
        gap: 1rem;
        margin-bottom: 2rem;
        padding: 1.5rem;
        background: rgba(255, 255, 255, 0.5);
        border-radius: 1rem;
        backdrop-filter: blur(10px);
        border: 1px solid rgba(255, 255, 255, 0.3);
        animation: fadeIn 0.8s ease-out 0.2s both;
    }

    @keyframes fadeIn {
        from { opacity: 0; }
        to { opacity: 1; }
    }

    .legend-item {
        display: flex;
        align-items: center;
        gap: 0.75rem;
        font-weight: 500;
        font-size: 0.95rem;
        padding: 0.5rem;
        border-radius: 0.5rem;
        transition: transform 0.2s ease;
    }

    .legend-item:hover {
        transform: translateY(-2px);
        background: rgba(255, 255, 255, 0.3);
    }

    .legend-color {
        width: 20px;
        height: 20px;
        border-radius: 50%;
        display: inline-block;
        box-shadow: var(--shadow-light);
    }

    #scheduleByDayContainer {
        display: grid;
        grid-template-columns: repeat(auto-fit, minmax(280px, 1fr));
        gap: 1.5rem;
        width: 100%;
    }

    .day-column {
        background: var(--card-bg);
        backdrop-filter: blur(10px);
        padding: 1.5rem;
        border-radius: var(--border-radius);
        box-shadow: var(--shadow-medium);
        border: 1px solid rgba(255, 255, 255, 0.2);
        transition: all 0.3s ease;
        animation: slideInUp 0.6s ease-out;
        animation-fill-mode: both;
        position: relative;
        overflow: hidden;
    }

    .day-column::before {
        content: '';
        position: absolute;
        top: 0;
        left: 0;
        right: 0;
        height: 4px;
        background: linear-gradient(90deg, var(--primary-color), var(--primary-dark));
        border-radius: var(--border-radius) var(--border-radius) 0 0;
    }

    @keyframes slideInUp {
        from {
            opacity: 0;
            transform: translateY(30px);
        }
        to {
            opacity: 1;
            transform: translateY(0);
        }
    }

    .day-column:hover {
        transform: translateY(-5px);
        box-shadow: var(--shadow-heavy);
    }

    .day-title {
        font-size: 1.4rem;
        font-weight: 700;
        margin-bottom: 1rem;
        color: var(--primary-color);
        text-align: center;
        padding-bottom: 0.5rem;
        border-bottom: 2px solid rgba(102, 126, 234, 0.2);
    }

    .arrival-time {
        font-size: 1rem;
        font-weight: 500;
        color: #718096;
        margin: 1rem 0;
        padding: 0.75rem;
        border-radius: 0.75rem;
        background: linear-gradient(135deg, rgba(255, 255, 255, 0.8), rgba(247, 250, 252, 0.8));
        border: 1px solid rgba(255, 255, 255, 0.5);
        text-align: center;
        box-shadow: var(--shadow-light);
    }

    .worker-list {
        list-style: none;
        padding: 0;
        margin: 0;
        display: grid;
        gap: 0.75rem;
    }

    .worker-item {
        padding: 1rem;
        border-radius: 0.75rem;
        font-weight: 600;
        color: white;
        text-shadow: 0 1px 2px rgba(0, 0, 0, 0.3);
        box-shadow: var(--shadow-medium);
        font-size: 1rem;
        text-align: center;
        transition: all 0.3s ease;
        position: relative;
        overflow: hidden;
    }

    .worker-item::before {
        content: '';
        position: absolute;
        top: 0;
        left: -100%;
        width: 100%;
        height: 100%;
        background: linear-gradient(90deg, transparent, rgba(255, 255, 255, 0.2), transparent);
        transition: left 0.5s ease;
    }

    .worker-item:hover {
        transform: scale(1.05);
        box-shadow: var(--shadow-heavy);
    }

    .worker-item:hover::before {
        left: 100%;
    }

    .role-runners { background: var(--runner-bg); }
    .role-waiters-hall { background: var(--waiter-hall-bg); }
    .role-waiters-terrace { background: var(--waiter-terrace-bg); }
    .role-hostess-hall { 
        background: var(--hostess-hall-bg); 
    }
    .role-hostess-terrace { 
        background: var(--hostess-terrace-bg); 
        color: var(--text-color);
        text-shadow: none;
    }
    .role-tastings { background: var(--tastings-bg); }

    #no-data-message {
        display: none;
        text-align: center;
        font-size: 1.2rem;
        padding: 2rem;
        background: linear-gradient(135deg, rgba(255, 243, 205, 0.9), rgba(255, 234, 167, 0.9));
        color: #975a16;
        border-radius: var(--border-radius);
        border: 1px solid rgba(255, 234, 167, 0.5);
        margin-top: 2rem;
        backdrop-filter: blur(10px);
        box-shadow: var(--shadow-medium);
    }

    .navigation-buttons {
        text-align: center;
        margin-top: 2rem;
        display: flex;
        justify-content: center;
        gap: 1rem;
        flex-wrap: wrap;
    }

    .nav-button {
        padding: 1rem 2rem;
        font-size: 1.1rem;
        font-weight: 600;
        color: white;
        border: none;
        border-radius: 0.75rem;
        cursor: pointer;
        transition: all 0.3s ease;
        display: inline-flex;
        align-items: center;
        gap: 0.5rem;
        text-decoration: none;
        box-shadow: var(--shadow-medium);
        position: relative;
        overflow: hidden;
    }

    .nav-button::before {
        content: '';
        position: absolute;
        top: 50%;
        left: 50%;
        width: 0;
        height: 0;
        background: rgba(255, 255, 255, 0.2);
        border-radius: 50%;
        transition: all 0.3s ease;
        transform: translate(-50%, -50%);
    }

    .nav-button:hover::before {
        width: 300px;
        height: 300px;
    }

    .nav-button:hover {
        transform: translateY(-3px);
        box-shadow: var(--shadow-heavy);
    }

    #backButton { 
        background: linear-gradient(135deg, var(--primary-color), var(--primary-dark));
    }

    #exportImageButton { 
        background: linear-gradient(135deg, var(--success-color), #38a169);
    }

    .nav-button:disabled {
        background: linear-gradient(135deg, #a0aec0, #718096);
        cursor: not-allowed;
        transform: none;
    }

    .nav-button:disabled:hover {
        transform: none;
        box-shadow: var(--shadow-medium);
    }

    .nav-button:disabled::before {
        display: none;
    }

    /* אנימציות עבור הכרטיסיות */
    .day-column:nth-child(1) { animation-delay: 0.1s; }
    .day-column:nth-child(2) { animation-delay: 0.2s; }
    .day-column:nth-child(3) { animation-delay: 0.3s; }
    .day-column:nth-child(4) { animation-delay: 0.4s; }
    .day-column:nth-child(5) { animation-delay: 0.5s; }
    .day-column:nth-child(6) { animation-delay: 0.6s; }
    .day-column:nth-child(7) { animation-delay: 0.7s; }

    @media (max-width: 768px) {
        body { padding: 0.75rem; }
        .container { padding: 1rem; }
        
        #scheduleByDayContainer {
            grid-template-columns: 1fr;
            gap: 1rem;
        }
        
        .legend {
            grid-template-columns: 1fr;
            gap: 0.5rem;
            padding: 1rem;
        }
        
        .nav-button { 
            width: 100%;
            max-width: 300px;
            padding: 0.875rem 1.5rem;
        }
        
        h2 { margin-bottom: 1.5rem; }
        .day-column { padding: 1rem; }
    }

    @media (max-width: 480px) {
        .container { padding: 0.75rem; }
        .legend { padding: 0.75rem; }
        .day-column { padding: 0.75rem; }
        .worker-item { padding: 0.75rem; }
    }

    /* הבטחת תצוגה טובה במסכים רחבים */
    @media (min-width: 1400px) {
        .container { max-width: 95vw; }
        #scheduleByDayContainer {
            grid-template-columns: repeat(auto-fit, minmax(320px, 1fr));
        }
    }

    @media (min-width: 1800px) {
        .container { max-width: 90vw; }
        #scheduleByDayContainer {
            grid-template-columns: repeat(auto-fit, minmax(350px, 1fr));
        }
    }
    </style>
</head>
<body>
    <div class="container" id="capture">
        <h2>סיכום סידור עבודה - לפי ימים</h2>

        <div class="legend" aria-hidden="true">
            <div class="legend-item">
                <span class="legend-color" style="background: var(--runner-bg)"></span>
                ראנר
            </div>
            <div class="legend-item">
                <span class="legend-color" style="background: var(--waiter-hall-bg)"></span>
                מלצר אולם
            </div>
            <div class="legend-item">
                <span class="legend-color" style="background: var(--waiter-terrace-bg)"></span>
                מלצר טרסה
            </div>
            <div class="legend-item">
                <span class="legend-color" style="background: var(--tastings-bg)"></span>
                טעימות
            </div>
            <div class="legend-item">
                <span class="legend-color" style="background: var(--hostess-hall-bg)"></span>
                מארחת אולם
            </div>
            <div class="legend-item">
                <span class="legend-color" style="background: var(--hostess-terrace-bg)"></span>
                מארחת טרסה
            </div>
        </div>

        <div id="scheduleByDayContainer" aria-live="polite"></div>

        <div id="no-data-message" role="status" aria-hidden="true">
            <h3 style="margin:0 0 1rem 0; font-size: 1.5rem;">אין נתוני שיבוץ</h3>
            <p style="margin:0; font-size: 1.1rem;">לא נמצא סידור עבודה שמור. יש לחזור לדף השיבוץ ולשבץ עובדים תחילה.</p>
        </div>
    </div>

    <div class="navigation-buttons">
        <a id="backButton" class="nav-button" href="main.html">
            ← חזרה לדף השיבוץ
        </a>
        <button id="exportImageButton" class="nav-button" disabled>
            📷 ייצוא כתמונה
        </button>
    </div>

    <script>
    // helper כדי לטעון ספריה חיצונית
    function loadScript(src){
        return new Promise((resolve,reject)=>{
            const s = document.createElement('script');
            s.src = src;
            s.onload = () => resolve();
            s.onerror = () => reject(new Error('failed to load ' + src));
            document.head.appendChild(s);
        });
    }

    document.addEventListener('DOMContentLoaded', () => {
        // נטען html2canvas ברקע (לא מחכה לו להצגה)
        loadScript('https://cdnjs.cloudflare.com/ajax/libs/html2canvas/1.4.1/html2canvas.min.js')
            .then(()=> {
                const exportBtn = document.getElementById('exportImageButton');
                exportBtn.disabled = false;
                exportBtn.style.opacity = '1';
            })
            .catch((err)=>{
                console.warn('html2canvas לא נטען:', err);
                const exportBtn = document.getElementById('exportImageButton');
                exportBtn.textContent = '📷 ייצוא לא זמין';
                exportBtn.disabled = true;
                exportBtn.style.background = 'linear-gradient(135deg, #a0aec0, #718096)';
                exportBtn.style.opacity = '1';
            });

        // טען את הנתונים - קודם sessionStorage (הכי עדכני), אחר כך localStorage
        let assignments = null;
        try {
            const sessionData = sessionStorage.getItem('workSchedule');
            if (sessionData) {
                assignments = JSON.parse(sessionData);
            } else {
                // ניסיון לקרוא localStorage - יתמוך במבנה שהבנית: { assignments, allDaysData, timestamp, version }
                const localRaw = localStorage.getItem('workScheduleData') || localStorage.getItem('workSchedule');
                if (localRaw) {
                    try {
                        const parsed = JSON.parse(localRaw);
                        // אם זה האובייקט המלא - יש לו שדה assignments; אחרת יתכן שהמשתמש שמר רק את ה-assignments
                        assignments = parsed.assignments ? parsed.assignments : parsed;
                    } catch(e) {
                        console.warn('שגיאה בפיענוח ה-localStorage:', e);
                        assignments = null;
                    }
                }
            }
        } catch (e) {
            console.warn('שגיאה בקריאת session/local storage:', e);
            assignments = null;
        }

        if (assignments && Object.keys(assignments).length > 0) {
            renderSchedule(assignments);
        } else {
            document.getElementById('no-data-message').style.display = 'block';
            document.getElementById('exportImageButton').style.display = 'none';
        }
    });

    function normalizeWorker(w){
        if (!w) return null;
        if (typeof w === 'string') return {name: w};
        if (typeof w === 'object' && (w.name || w.username)) return { name: w.name || w.username };
        return { name: String(w) };
    }

    function renderSchedule(schedule) {
        const container = document.getElementById('scheduleByDayContainer');
        container.innerHTML = '';
        document.getElementById('no-data-message').style.display = 'none';
        const dayOrder = ['ראשון','שני','שלישי','רביעי','חמישי','שישי','שבת'];
        const MAX_PER_COLUMN = 25; // הקטנתי קצת כדי שהכרטיסיות יהיו יותר מאוזנות
        let hasAny = false;

        // מיון ימים — אם יש שמות יום סטנדרטיים, ימיינו לפי סדר השבוע; אחרת נשאיר לפי מפתח
        const days = Object.keys(schedule || {});
        days.sort((a,b)=>{
            const ia = dayOrder.indexOf(a);
            const ib = dayOrder.indexOf(b);
            if (ia !== -1 && ib !== -1) return ia - ib;
            if (ia !== -1) return -1;
            if (ib !== -1) return 1;
            return a.localeCompare(b, 'he');
        });

        days.forEach(day => {
            const dayDataRaw = schedule[day] || {};
            // ננרמל מבנים שונים (מחרוזת/אובייקט/שדה חסר)
            const map = arr => (Array.isArray(arr) ? arr.map(normalizeWorker).filter(Boolean) : []);
            const runners = map(dayDataRaw.runners);
            const waitersHall = map((dayDataRaw.waiters && dayDataRaw.waiters.hall) || []);
            const waitersTerrace = map((dayDataRaw.waiters && dayDataRaw.waiters.terrace) || []);
            const tastings = map(dayDataRaw.tastings);
            const hostessHall = map((dayDataRaw.hostess && dayDataRaw.hostess.hall) || []);
            const hostessTerrace = map((dayDataRaw.hostess && dayDataRaw.hostess.terrace) || []);

            const addRole = (arr, roleClass) => arr.map(w => ({...w, roleClass}));
            const allWorkers = [
                ...addRole(runners, 'role-runners'),
                ...addRole(waitersHall, 'role-waiters-hall'),
                ...addRole(waitersTerrace, 'role-waiters-terrace'),
                ...addRole(tastings, 'role-tastings'),
                ...addRole(hostessHall, 'role-hostess-hall'),
                ...addRole(hostessTerrace, 'role-hostess-terrace')
            ];

            if (allWorkers.length === 0) return; // אין שיבוצים ליום זה

            hasAny = true;
            const totalColumns = Math.ceil(allWorkers.length / MAX_PER_COLUMN) || 1;
            for (let col = 0; col < totalColumns; col++) {
                const dayColumn = document.createElement('div');
                dayColumn.className = 'day-column';
                const title = document.createElement('div');
                title.className = 'day-title';
                title.textContent = col === 0 ? day : `${day} - המשך ${col + 1}`;
                dayColumn.appendChild(title);

                if (dayDataRaw.arrivalTime && col === 0) {
                    const arrival = document.createElement('div');
                    arrival.className = 'arrival-time';
                    arrival.textContent = `⏰ שעת הגעה: ${dayDataRaw.arrivalTime}`;
                    dayColumn.appendChild(arrival);
                }

                const ul = document.createElement('ul');
                ul.className = 'worker-list';

                const start = col * MAX_PER_COLUMN;
                const end = start + MAX_PER_COLUMN;
                const chunk = allWorkers.slice(start, end);
                chunk.forEach(w => {
                    const li = document.createElement('li');
                    li.className = `worker-item ${w.roleClass}`;
                    li.textContent = w.name;
                    ul.appendChild(li);
                });

                dayColumn.appendChild(ul);
                container.appendChild(dayColumn);
            }
        });

        if (!hasAny) {
            document.getElementById('no-data-message').style.display = 'block';
            document.getElementById('exportImageButton').style.display = 'none';
        } else {
            // לחץ על הכפתור ייצא תמונה של כל ה-container
            document.getElementById('exportImageButton').style.display = 'inline-flex';
        }
    }

    // --- ייצוא לתמונה ---
    document.getElementById('exportImageButton').addEventListener('click', async function(){
        if (typeof html2canvas === 'undefined') {
            alert('html2canvas עדיין לא נטען. אנא המתן שניות ספורות ונסה שוב.');
            return;
        }
        const exportBtn = this;
        const backBtn = document.getElementById('backButton');
        exportBtn.disabled = true;
        exportBtn.textContent = '📷 מכין תמונה...';
        backBtn.style.display = 'none';

        const element = document.getElementById('capture');
        
        // שמירת הסגנונות המקוריים
        const originalBodyStyle = document.body.style.cssText;
        const originalContainerStyle = element.style.cssText;
        
        try {
            // החלפה זמנית לסגנון פשוט לייצוא
            document.body.style.cssText = `
                background: #f0f4f8 !important;
                font-family: 'Rubik', sans-serif;
                direction: rtl;
                padding: 20px;
            `;
            
            element.style.cssText = `
                background: white !important;
                padding: 30px !important;
                border-radius: 15px !important;
                box-shadow: 0 10px 30px rgba(0,0,0,0.1) !important;
                border: 2px solid #e2e8f0 !important;
                backdrop-filter: none !important;
            `;
            
            // וידוא שכל הכרטיסיות יהיו עם רקע לבן מוצק
            const dayColumns = element.querySelectorAll('.day-column');
            const originalColumnStyles = [];
            dayColumns.forEach((col, index) => {
                originalColumnStyles[index] = col.style.cssText;
                col.style.cssText = `
                    background: white !important;
                    backdrop-filter: none !important;
                    padding: 20px !important;
                    border-radius: 12px !important;
                    box-shadow: 0 4px 12px rgba(0,0,0,0.1) !important;
                    border: 1px solid #e2e8f0 !important;
                    margin-bottom: 15px;
                `;
            });
            
            // וידוא שהכרטיסיות של העובדים יהיו עם הצבעים הנכונים
            const workerItems = element.querySelectorAll('.worker-item');
            const originalWorkerStyles = [];
            workerItems.forEach((item, index) => {
                originalWorkerStyles[index] = item.style.cssText;
                // שמירה על מחלקת ה-CSS המקורית אבל עם background מפורש
                if (item.classList.contains('role-runners')) {
                    item.style.background = '#28a745 !important';
                } else if (item.classList.contains('role-waiters-hall')) {
                    item.style.background = '#38516d !important';
                } else if (item.classList.contains('role-waiters-terrace')) {
                    item.style.background = '#022346 !important';
                } else if (item.classList.contains('role-tastings')) {
                    item.style.background = '#17a2b8 !important';
                } else if (item.classList.contains('role-hostess-hall')) {
                    item.style.background = '#96009b !important';
                } else if (item.classList.contains('role-hostess-terrace')) {
                    item.style.background = '#ff7fc7 !important';
                    item.style.color = '#2d3748 !important';
                }
                item.style.cssText += `
                    color: white !important;
                    font-weight: 600 !important;
                    padding: 12px !important;
                    border-radius: 8px !important;
                    margin: 8px 0 !important;
                    text-align: center !important;
                    box-shadow: 0 2px 8px rgba(0,0,0,0.15) !important;
                `;
                // תיקון מיוחד למארחת טרסה
                if (item.classList.contains('role-hostess-terrace')) {
                    item.style.color = '#2d3748 !important';
                }
            });

            // המתנה קצרה לוידוא שהשינויים נכנסו לתוקף
            await new Promise(resolve => setTimeout(resolve, 500));
            
            const canvas = await html2canvas(element, {
                scale: 2,
                useCORS: true,
                backgroundColor: '#f0f4f8',
                logging: false,
                allowTaint: false,
                foreignObjectRendering: false,
                imageTimeout: 30000,
                removeContainer: true,
                scrollX: 0,
                scrollY: 0,
                windowWidth: element.scrollWidth + 100,
                windowHeight: element.scrollHeight + 100
            });
            
            // שחזור הסגנונות המקוריים
            document.body.style.cssText = originalBodyStyle;
            element.style.cssText = originalContainerStyle;
            dayColumns.forEach((col, index) => {
                col.style.cssText = originalColumnStyles[index];
            });
            workerItems.forEach((item, index) => {
                item.style.cssText = originalWorkerStyles[index];
            });
            
            const dataURL = canvas.toDataURL('image/png', 0.95);
            const link = document.createElement('a');
            link.download = `work-schedule-${getFormattedDate()}.png`;
            link.href = dataURL;
            document.body.appendChild(link);
            link.click();
            document.body.removeChild(link);
            
        } catch (err) {
            console.error('שגיאה ביצירת התמונה:', err);
            alert('שגיאה בייצוא התמונה: ' + (err.message || err));
            
            // שחזור הסגנונות המקוריים גם במקרה של שגיאה
            document.body.style.cssText = originalBodyStyle;
            element.style.cssText = originalContainerStyle;
        } finally {
            exportBtn.disabled = false;
            exportBtn.textContent = '📷 ייצוא כתמונה';
            backBtn.style.display = 'inline-flex';
        }
    });

    function getFormattedDate(){
        const d = new Date();
        const Y = d.getFullYear();
        const M = String(d.getMonth()+1).padStart(2,'0');
        const D = String(d.getDate()).padStart(2,'0');
        const h = String(d.getHours()).padStart(2,'0');
        const m = String(d.getMinutes()).padStart(2,'0');
        return `${Y}-${M}-${D}_${h}-${m}`;
    }
    </script>
</body>
</html>
